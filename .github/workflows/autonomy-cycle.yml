name: Autonomy Cycle (Backlog)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: autonomy-cycle-${{ github.repository }}
  cancel-in-progress: false

jobs:
  cycle:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup PowerShell
        uses: PowerShell/PowerShell@v1
        with:
          version: "7.4.x"

      - name: Install deps
        run: npm ci

      - name: Configure git
        run: |
          git config user.name "Plugaishop Autonomy"
          git config user.email "autonomy@plugaishop.ai"

      - name: Run one autonomy cycle
        id: cycle
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          BASE_BRANCH="main"
          git fetch origin "$BASE_BRANCH"
          git checkout -B "$BASE_BRANCH" "origin/$BASE_BRANCH"

          BRANCH="autonomy/cycle-${{ github.run_id }}-${{ github.run_attempt }}"
          git checkout -b "$BRANCH"

          # roda autonomia (falha se der erro)
          npm run autonomy

          # detecta mudanças de trabalho
          if [ -z "$(git status --porcelain)" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # commit automático do que mudou
          git add -A
          git commit -m "chore(ops): autonomy cycle ${{ github.run_id }}" || true

          # se ainda não tiver commit (ex: só timestamps ignorados), sai
          if [ -z "$(git status --porcelain)" ] && [ "$(git rev-list --count HEAD ^origin/$BASE_BRANCH)" -eq 0 ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git push -u origin "$BRANCH"
          echo "changed=true" >> "$GITHUB_OUTPUT"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Create PR (only when changed)
        if: steps.cycle.outputs.changed == 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          BRANCH="${{ steps.cycle.outputs.branch }}"
          TITLE="chore(ops): autonomy cycle ${{ github.run_id }}"
          BODY=$'Automated autonomy cycle.\n\n- Source: ops/backlog.queue.yml\n- Runner: tools/autonomy-core/runner.ps1\n\nIf this PR only changes runtime state files, you can close it safely.'

          # PR pode já existir em rerun
          if gh pr view --head "$BRANCH" --json url >/dev/null 2>&1; then
            echo "PR already exists for $BRANCH"
            exit 0
          fi

          # labels são opcionais (não falha se não existirem)
          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "$TITLE" \
            --body "$BODY" \
            --label "autopilot,risk-low" || \
          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "$TITLE" \
            --body "$BODY"