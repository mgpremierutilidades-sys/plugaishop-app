name: Autonomy Cycle (Backlog)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: autonomy-cycle-${{ github.repository }}
  cancel-in-progress: false

jobs:
  cycle:
    runs-on: windows-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci --no-audit --fund=false

      - name: Configure git
        run: |
          git config user.name "Plugaishop Autonomy"
          git config user.email "autonomy@plugaishop.ai"

      - name: Prepare branches
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $BASE_BRANCH = "main"
          git fetch origin $BASE_BRANCH
          git checkout -B $BASE_BRANCH ("origin/" + $BASE_BRANCH)
          $BRANCH = "autonomy/cycle-${{ github.run_id }}-${{ github.run_attempt }}"
          git checkout -b $BRANCH
          "BRANCH=$BRANCH" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Run autonomy (retry x3)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 12
          max_attempts: 3
          retry_on: error
          command: npm run autonomy
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_TOKEN: ${{ github.token }}

      - name: Commit if changed
        id: commit
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $status = git status --porcelain
          if ([string]::IsNullOrWhiteSpace($status)) {
            "changed=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            exit 0
          }

          git add -A
          git commit -m "chore(ops): autonomy cycle ${{ github.run_id }}" | Out-Null

          git push -u origin $env:BRANCH
          "changed=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Create PR (only when changed)
        if: steps.commit.outputs.changed == 'true'
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          $ErrorActionPreference = "Stop"

          $BRANCH = $env:BRANCH
          $TITLE  = "chore(ops): autonomy cycle ${{ github.run_id }}"
          $BODY   = "Automated autonomy cycle.`n`n- Source: ops/backlog.queue.yml`n- Runner: tools/autonomy-core/runner.ps1`n`nIf this PR only changes runtime state files, you can close it safely."

          try {
            gh pr view --head $BRANCH --json url | Out-Null
            Write-Host "PR already exists for $BRANCH"
            exit 0
          } catch {}

          try {
            gh pr create --base main --head $BRANCH --title $TITLE --body $BODY --label "autopilot,risk-low" | Out-Null
          } catch {
            gh pr create --base main --head $BRANCH --title $TITLE --body $BODY | Out-Null
          }