name: Backlog Ingest (Issues -> ops/backlog.queue.yml)

on:
  workflow_dispatch:
  schedule:
    - cron: "5 * * * *" # hourly (5 min after the hour)

permissions:
  contents: write
  issues: read

concurrency:
  group: backlog-ingest-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ingest:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "Plugaishop Autonomy"
          git config user.email "autonomy@plugaishop.ai"

      - name: Ingest autopilot issues into ops/backlog.queue.yml
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail

          BACKLOG="ops/backlog.queue.yml"
          mkdir -p ops

          if [ ! -f "$BACKLOG" ]; then
            printf "" > "$BACKLOG"
          fi

          existing_ids="$(grep -E '^[[:space:]]*-[[:space:]]+id:[[:space:]]*' "$BACKLOG" \
            | sed -E 's/^[[:space:]]*-[[:space:]]+id:[[:space:]]*//' \
            | tr -d '\r' || true)"

          issues_json="$(gh issue list --state open --label autopilot --limit 200 --json number,title,labels)"

          changed=0

          echo "$issues_json" | jq -c '.[]' | while read -r item; do
            num="$(echo "$item" | jq -r '.number')"
            title="$(echo "$item" | jq -r '.title')"
            bid="ISSUE-${num}"

            if echo "$existing_ids" | grep -qx "$bid"; then
              continue
            fi

            areaLabel="$(echo "$item" | jq -r '[.labels[].name | select(startswith("area:"))][0] // "area:backlog"')"
            area="${areaLabel#area:}"

            riskLabel="$(echo "$item" | jq -r '[.labels[].name | select(startswith("risk-"))][0] // "risk-low"')"
            risk="${riskLabel#risk-}"
            case "$risk" in
              low|med|high) ;;
              *) risk="low" ;;
            esac

            {
              echo "- id: ${bid}"
              echo "  area: ${area}"
              echo "  title: \"${title//\"/\\\"}\""
              echo "  target_files:"
              echo "    - (from_issue)"
              echo "  flag: automation-remote-workflow"
              echo "  metrics:"
              echo "    - issue_ingested"
              echo "  status: queued"
              echo "  risk: ${risk}"
              echo "  issue_number: ${num}"
              echo ""
            } >> "$BACKLOG"

            changed=1
          done

          if [ "$changed" -eq 1 ] && ! git diff --quiet; then
            git add "$BACKLOG"
            git commit -m "chore(backlog): ingest autopilot issues" || true
            git push origin HEAD:main
            echo "Backlog updated."
          else
            echo "No changes."
          fi