name: AI Queue Worker

on:
  issues:
    types: [labeled, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: ai-queue-${{ github.repository }}-issue-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  run:
    if: |
      github.event_name == 'issues' &&
      (
        (github.event.action == 'labeled' && github.event.label.name == 'ai:queue') ||
        (github.event.action == 'edited' && contains(join(github.event.issue.labels.*.name, ','), 'ai:queue'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup PowerShell
        uses: PowerShell/PowerShell@v1
        with:
          version: "7.4.x"

      - name: Install deps
        run: npm ci --no-audit --fund=false

      # Executa o worker e captura status sem matar o job (para podermos comentar/remover label no final)
      - name: Run AI Queue Worker
        id: worker
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          set +e
          pwsh -NoProfile -ExecutionPolicy Bypass -File ./scripts/ai/github-queue-worker.ps1 \
            -IssueNumber "$ISSUE_NUMBER" \
            -Repo "$REPO" \
            -Fast -Once
          code=$?
          set -e

          echo "exit_code=$code" >> "$GITHUB_OUTPUT"

          if [ "$code" -eq 0 ]; then
            echo "result=ok" >> "$GITHUB_OUTPUT"
          else
            echo "result=fail" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload AI artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-artifacts-issue-${{ github.event.issue.number }}
          path: |
            scripts/ai/_out
            scripts/ai/_state
            tools/autonomy-core/_out
          if-no-files-found: ignore

      # Descobre PR criado (se existir) pela branch padr√£o do worker (ou qualquer PR recente do bot)
      - name: Detect PR (best effort)
        id: pr
        if: always()
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          set -euo pipefail

          # Tenta encontrar PR referenciando a issue ou criado recentemente pelo workflow.
          # 1) Se o worker criou PR com t√≠tulo/branch previs√≠vel, preferimos isso.
          # 2) Fallback: buscar PRs abertos do repo e filtrar por refer√™ncia "#ISSUE_NUMBER" no t√≠tulo/body.
          pr_url=""

          # busca PRs abertos e tenta achar refer√™ncia ao n√∫mero da issue
          pr_url="$(gh pr list --repo "$REPO" --state open --limit 50 --json url,title,body \
            --jq ".[] | select((.title|test(\"#${ISSUE_NUMBER}\")) or ((.body // \"\")|test(\"#${ISSUE_NUMBER}\"))) | .url" | head -n 1 || true)"

          echo "url=$pr_url" >> "$GITHUB_OUTPUT"

      # Coment√°rio final + remo√ß√£o de label (sempre)
      - name: Comment on issue + remove ai:queue label
        if: always()
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -euo pipefail

          result="${{ steps.worker.outputs.result }}"
          code="${{ steps.worker.outputs.exit_code }}"
          pr="${{ steps.pr.outputs.url }}"

          if [ -z "$result" ]; then result="unknown"; fi
          if [ -z "$code" ]; then code="n/a"; fi

          status_line="**Result:** \`${result}\` (exit=${code})"
          pr_line=""
          if [ -n "$pr" ]; then
            pr_line=$'\n'"**PR:** ${pr}"
          fi

          body=$'### ü§ñ AI Queue Worker\n\n'"${status_line}${pr_line}"$'\n\n'"**Run:** ${RUN_URL}"$'\n'

          # comenta na issue
          gh issue comment "$ISSUE_NUMBER" --repo "$REPO" --body "$body" || true

          # remove label ai:queue (evita rerun infinito por issue edit)
          gh issue edit "$ISSUE_NUMBER" --repo "$REPO" --remove-label "ai:queue" || true

      # Se o worker falhou, falha o job no final (mas s√≥ depois de comentar e remover label)
      - name: Fail job when worker fails (after cleanup)
        if: steps.worker.outputs.result == 'fail'
        run: |
          exit 1