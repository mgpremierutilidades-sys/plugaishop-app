name: AI Queue Worker

on:
  issues:
    types: [labeled, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: ai-queue-${{ github.repository }}-issue-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  run:
    if: |
      github.event_name == 'issues' &&
      (
        (github.event.action == 'labeled' && github.event.label.name == 'ai:queue') ||
        (github.event.action == 'edited' && contains(join(github.event.issue.labels.*.name, ','), 'ai:queue'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # âœ… FIX: nÃ£o usa action inexistente; garante pwsh de forma determinÃ­stica
      - name: Ensure PowerShell (pwsh)
        shell: bash
        run: |
          set -euo pipefail
          if command -v pwsh >/dev/null 2>&1; then
            pwsh --version
            exit 0
          fi
          sudo apt-get update
          sudo apt-get install -y powershell
          pwsh --version

      - name: Install deps
        run: npm ci --no-audit --fund=false

      - name: Run AI Queue Worker
        id: worker
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          set +e
          pwsh -NoProfile -ExecutionPolicy Bypass -File ./scripts/ai/github-queue-worker.ps1 \
            -IssueNumber "$ISSUE_NUMBER" \
            -Repo "$REPO" \
            -Fast -Once
          code=$?
          set -e

          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          if [ "$code" -eq 0 ]; then
            echo "result=ok" >> "$GITHUB_OUTPUT"
          else
            echo "result=fail" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload AI artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-artifacts-issue-${{ github.event.issue.number }}
          path: |
            scripts/ai/_out
            scripts/ai/_state
            tools/autonomy-core/_out
          if-no-files-found: ignore

      - name: Detect PR (best effort)
        id: pr
        if: always()
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          set -euo pipefail
          pr_url=""
          pr_url="$(gh pr list --repo "$REPO" --state open --limit 50 --json url,title,body \
            --jq ".[] | select((.title|test(\"#${ISSUE_NUMBER}\")) or ((.body // \"\")|test(\"#${ISSUE_NUMBER}\"))) | .url" | head -n 1 || true)"
          echo "url=$pr_url" >> "$GITHUB_OUTPUT"

      - name: Comment on issue + finalize labels
        if: always()
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -euo pipefail

          result="${{ steps.worker.outputs.result }}"
          code="${{ steps.worker.outputs.exit_code }}"
          pr="${{ steps.pr.outputs.url }}"

          if [ -z "$result" ]; then result="unknown"; fi
          if [ -z "$code" ]; then code="n/a"; fi

          status_line="**Result:** \`${result}\` (exit=${code})"
          pr_line=""
          if [ -n "$pr" ]; then pr_line=$'\n'"**PR:** ${pr}"; fi

          body=$'### ðŸ¤– AI Queue Worker\n\n'"${status_line}${pr_line}"$'\n\n'"**Run:** ${RUN_URL}"$'\n'

          gh issue comment "$ISSUE_NUMBER" --repo "$REPO" --body "$body" || true
          gh issue edit "$ISSUE_NUMBER" --repo "$REPO" --remove-label "ai:queue" || true

          if [ "$result" = "fail" ]; then
            gh issue edit "$ISSUE_NUMBER" --repo "$REPO" --add-label "ai:failed" || true
          elif [ "$result" = "ok" ]; then
            gh issue edit "$ISSUE_NUMBER" --repo "$REPO" --add-label "ai:done" || true
          fi

      - name: Fail job when worker fails (after cleanup)
        if: steps.worker.outputs.result == 'fail'
        run: exit 1